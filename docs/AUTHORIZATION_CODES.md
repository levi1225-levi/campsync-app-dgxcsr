
# Authorization Code System

CampSync uses a secure authorization code system to control user registration and enforce role-based access control. This prevents spam accounts, eliminates role abuse, and ensures every user enters the system intentionally.

## Overview

All user accounts in CampSync are created through authorization codes. There is no open registration. Each code:

- Defines the user's role (super-admin, camp-admin, staff, or parent)
- Can be time-limited with an expiration date
- Can have usage limits (single-use or multi-use)
- For parents: automatically links to specific campers
- Is fully auditable with creation tracking

## Database Schema

### authorization_codes Table

```sql
- id: uuid (primary key)
- code: text (unique, the actual code string)
- role: text (super-admin, camp-admin, staff, parent)
- is_active: boolean (can be deactivated)
- expires_at: timestamptz (optional expiration)
- max_uses: integer (optional usage limit)
- used_count: integer (tracks usage)
- linked_camper_ids: uuid[] (for parent codes)
- created_by: uuid (references auth.users)
- created_at: timestamptz
- updated_at: timestamptz
```

## Code Types

### 1. Super Admin Code

- **Purpose**: Grant full system access
- **Characteristics**:
  - Hardcoded in system logic
  - Never expires
  - Unlimited uses
  - Code: `SUPER_ADMIN_2024`

### 2. Staff / Management Codes

- **Purpose**: Onboard staff and camp administrators
- **Characteristics**:
  - Generated by authorized users (super-admin or camp-admin)
  - No camper linkage
  - Optional expiration and usage limits
  - Can be deactivated at any time

### 3. Parent Invitation Codes

- **Purpose**: Invite parents to register and link to their children
- **Characteristics**:
  - Auto-generated by the system or admins
  - Linked to one or more campers
  - Usually single-use
  - Expire after 30 days by default
  - Demo code: `DEMO_PARENT_2024`

## Registration Flow

### Step 1: Code Validation

When a user enters a code during signup, the system validates:

1. The code exists
2. `is_active = true`
3. `expires_at` is null or in the future
4. `max_uses` is null or `used_count < max_uses`

If valid, the system returns:
- The role associated with the code
- Any camper links (parent codes only)

Invalid or expired codes are rejected immediately.

### Step 2: Account Creation

When signup is completed, the system:

1. Re-validates the authorization code
2. Creates the user account in Supabase Auth
3. Creates a user profile with the role from the code
4. Assigns the role defined by the code
5. Increments `used_count` atomically
6. Issues an authentication token for immediate login

### Step 3: Parent-Specific Linking

If the role is `parent`, the system links campers using two mechanisms:

#### A) Code-based linking
- Campers explicitly listed in `linked_camper_ids`

#### B) Email-based auto-matching
- The system searches all campers for emergency contacts whose email matches the parent's registration email
- Any matching campers are automatically linked

The final linked camper list is the **union** of both methods (no duplicates).

## Security Features

### Atomic Operations

Code usage is incremented atomically using a database function to prevent race conditions:

```sql
create or replace function increment_code_usage(p_code_id uuid)
returns void
language plpgsql
security definer
as $$
begin
  update authorization_codes
  set used_count = used_count + 1,
      updated_at = now()
  where id = p_code_id;
end;
$$;
```

### Row Level Security (RLS)

Authorization codes table has RLS policies:

- Only super-admins and camp-admins can view, create, and update codes
- Code validation is handled through a security definer function
- Parents and staff cannot access the codes table directly

### Audit Trail

Every code tracks:
- Who created it (`created_by`)
- When it was created (`created_at`)
- When it was last updated (`updated_at`)
- How many times it's been used (`used_count`)

## Admin Management

### Creating Codes

Admins can create authorization codes through:

1. **UI**: Navigate to Home → Authorization Codes → Create New Code
2. **Edge Function**: Call `generate-parent-invitation` for parent codes
3. **Direct Database**: Insert into `authorization_codes` table (super-admin only)

### Managing Codes

Admins can:

- View all authorization codes
- See usage statistics
- Deactivate codes
- Check expiration dates
- View linked campers (for parent codes)

### Parent Invitation Workflow

1. Admin creates/imports campers
2. System generates parent invitation code via Edge Function
3. Code is linked to specific camper(s)
4. Email invitation sent to parent (TODO: integrate email service)
5. Parent registers using the code
6. System automatically links parent to campers

## API Reference

### Services

#### `authorizationCode.service.ts`

- `validateAuthorizationCode(code: string)`: Validates a code
- `incrementCodeUsage(codeId: string)`: Increments usage count
- `createAuthorizationCode(params)`: Creates a new code
- `listAuthorizationCodes()`: Lists all codes (admin only)
- `deactivateAuthorizationCode(codeId: string)`: Deactivates a code
- `generateParentInvitationCode(camperIds: string[])`: Creates parent code
- `findCampersByParentEmail(email: string)`: Finds campers by emergency contact email

#### `parentInvitation.service.ts`

- `generateParentInvitation(params)`: Calls Edge Function to generate parent invitation

### Edge Functions

#### `generate-parent-invitation`

Generates a parent invitation code and (optionally) sends an email.

**Request:**
```json
{
  "camperIds": ["uuid1", "uuid2"],
  "parentEmail": "parent@example.com",
  "parentName": "John Doe"
}
```

**Response:**
```json
{
  "success": true,
  "code": "PARENT_ABC123_XYZ789",
  "expiresAt": "2024-02-15T00:00:00Z",
  "message": "Invitation code generated for John Doe"
}
```

## Screens

### `/register`

User registration screen with two steps:
1. Enter and validate authorization code
2. Complete profile information

### `/manage-authorization-codes`

Admin screen to:
- View all authorization codes
- Create new codes
- Deactivate codes
- See usage statistics

## Best Practices

1. **Single-use parent codes**: Always set `max_uses: 1` for parent invitation codes
2. **Expiration dates**: Set reasonable expiration dates (30 days for parents, longer for staff)
3. **Deactivate unused codes**: Regularly review and deactivate codes that are no longer needed
4. **Email matching**: Ensure emergency contact emails are accurate for auto-matching
5. **Audit regularly**: Review code usage and creation logs for security

## Future Enhancements

- [ ] Email integration for automatic parent invitations
- [ ] Bulk code generation for staff onboarding
- [ ] Code usage analytics and reporting
- [ ] QR code generation for easy code sharing
- [ ] SMS-based code delivery
- [ ] Code expiration reminders
